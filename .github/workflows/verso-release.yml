name: Verso Release

on:
  push:
    tags:
      - "verso-v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g. 1.0.0)"
        required: true

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            TAG="${GITHUB_REF#refs/tags/verso-v}"
            echo "version=$TAG" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build
        run: dotnet build Verso.sln -c Release -p:Version=${{ steps.version.outputs.version }}

      - name: Test
        run: dotnet test Verso.sln -c Release --no-build

      - name: Pack NuGet packages
        run: |
          dotnet pack src/Verso.Abstractions/Verso.Abstractions.csproj -c Release -p:Version=${{ steps.version.outputs.version }} -o packages
          dotnet pack src/Verso/Verso.csproj -c Release -p:Version=${{ steps.version.outputs.version }} -o packages
          dotnet pack src/Verso.Ado/Verso.Ado.csproj -c Release -p:Version=${{ steps.version.outputs.version }} -o packages
          dotnet pack src/Verso.FSharp/Verso.FSharp.csproj -c Release -p:Version=${{ steps.version.outputs.version }} -o packages
          dotnet pack src/Verso.Testing/Verso.Testing.csproj -c Release -p:Version=${{ steps.version.outputs.version }} -o packages
          dotnet pack templates/Verso.Templates/Verso.Templates.csproj -c Release -p:Version=${{ steps.version.outputs.version }} -o packages

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: packages/*.nupkg

  build-vsix:
    name: Build VSIX
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Set version
        run: npm version ${{ needs.build-and-test.outputs.version }} --no-git-tag-version
        working-directory: vscode

      - name: Install dependencies
        run: npm ci
        working-directory: vscode

      - name: Build all
        run: npm run build:all
        working-directory: vscode

      - name: Package VSIX
        run: npx vsce package --skip-license
        working-directory: vscode

      - name: Upload VSIX
        uses: actions/upload-artifact@v4
        with:
          name: verso-vsix
          path: vscode/*.vsix

  publish-nuget:
    name: Publish to NuGet
    runs-on: ubuntu-latest
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/verso-v')

    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: packages

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Push to NuGet.org
        run: |
          for pkg in packages/*.nupkg; do
            echo "Publishing $pkg..."
            dotnet nuget push "$pkg" \
              --api-key "${{ secrets.NUGET_API_KEY }}" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-test, build-vsix, publish-nuget]
    if: startsWith(github.ref, 'refs/tags/verso-v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: packages

      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: verso-vsix
          path: vsix

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            packages/*.nupkg
            vsix/*.vsix
