@page "/"
@implements IDisposable
@inject INotebookService Service
@inject IJSRuntime JS

<PageTitle>Verso Notebook</PageTitle>

<ThemeProvider Theme="@Service.ActiveThemeData" />

<div class="verso-notebook"
     tabindex="0" @onkeydown="HandleKeyDown">
    <Toolbar Service="Service"
             SelectedCellId="_selectedCellId"
             OnNewNotebook="HandleNew"
             OnOpenNotebook="HandleOpen"
             OnBrowseNotebook="HandleBrowse"
             OnSaveNotebook="HandleSave"
             OnAddCell="HandleAddCell"
             OnActionExecuted="HandleActionExecuted"
             OnError="HandleError" />

    @if (_showSaveDialog)
    {
        <div class="verso-modal-overlay" @onclick="CancelSaveDialog">
            <div class="verso-modal" @onclick:stopPropagation="true">
                <div class="verso-modal-header">
                    <span class="verso-modal-title">Save Notebook As</span>
                    <button class="verso-modal-close" @onclick="CancelSaveDialog" title="Cancel">
                        <svg viewBox="0 0 16 16" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"><line x1="4" y1="4" x2="12" y2="12"/><line x1="12" y1="4" x2="4" y2="12"/></svg>
                    </button>
                </div>
                <div class="verso-modal-body">
                    <label class="verso-modal-label" for="savePath">Save to:</label>
                    <input id="savePath" class="verso-modal-input"
                           @bind="_saveFilePath" @bind:event="oninput"
                           @onkeydown="OnSaveDialogKeyDown"
                           @ref="_saveDialogInput"
                           spellcheck="false"
                           autocomplete="off" />
                    <div class="verso-modal-hint">
                        Enter the full file path. The <code>.verso</code> extension will be added if missing.
                    </div>
                </div>
                <div class="verso-modal-footer">
                    <button class="verso-modal-btn verso-modal-btn--secondary"
                            @onclick="CancelSaveDialog">Cancel</button>
                    <button class="verso-modal-btn verso-modal-btn--primary"
                            @onclick="ConfirmSaveDialog"
                            disabled="@string.IsNullOrWhiteSpace(_saveFilePath)">Save</button>
                </div>
            </div>
        </div>
    }

    @if (_error is not null)
    {
        <div class="verso-error-banner">
            <span>@_error</span>
            <button @onclick="() => _error = null">Dismiss</button>
        </div>
    }

    @if (_statusMessage is not null)
    {
        <div class="verso-status-banner">
            <span>@_statusMessage</span>
        </div>
    }

    @if (!Service.IsLoaded)
    {
        <div class="verso-welcome">
            <h1>Verso Notebook</h1>
            <p>Create a new notebook or open an existing <code>.verso</code> or <code>.ipynb</code> file to get started.</p>
            <button class="verso-welcome-btn" @onclick="HandleNew">New Notebook</button>
        </div>
    }
    else
    {
        <div class="verso-notebook-body">
            <div class="verso-notebook-main">
                @if (Service.IsDashboardLayout)
                {
                    <DashboardGrid Service="Service"
                                   Cells="Service.Cells"
                                   ExecutingCellId="_executingCellId"
                                   OnRunCell="HandleRunCell"
                                   OnSourceChanged="HandleSourceChanged" />
                }
                else
                {
                    <div class="verso-cell-list" @onclick="HandleCellListClick">
                        @{
                            var cells = Service.Cells;
                            var cellTypes = Service.AvailableCellTypes;
                        }
                        @for (int i = 0; i < cells.Count; i++)
                        {
                            var cell = cells[i];
                            var index = i;
                            <div @onclick:stopPropagation="true">
                                <Cell CellData="cell"
                                      IsSelected="cell.Id == _selectedCellId"
                                      IsExecuting="cell.Id == _executingCellId"
                                      Index="index"
                                      IsLast="index == cells.Count - 1"
                                      CollapsesInput="Service.ShouldCollapseInput(cell.Type)"
                                      OnRunCell="HandleRunCell"
                                      OnDeleteCell="HandleDeleteCell"
                                      OnSelect="HandleSelectCell"
                                      OnMoveUp="HandleMoveUp"
                                      OnMoveDown="HandleMoveDown"
                                      OnSourceChanged="HandleSourceChanged"
                                      OnCellAction="HandleCellAction"
                                      OnCellTypeChanged="HandleCellTypeChanged" />
                            </div>

                            @if (index < cells.Count - 1)
                            {
                                var insertIndex = index + 1;
                                <div class="verso-insert-cell-row @(cell.Id == _selectedCellId ? "verso-insert-cell-row--visible" : "")">
                                    <div class="verso-insert-cell-line"></div>
                                    @foreach (var ct in cellTypes)
                                    {
                                        var idx = insertIndex;
                                        var typeId = ct.Id;
                                        <button class="verso-insert-cell-btn" @onclick="() => HandleInsertCell(idx, typeId)">+ @ct.DisplayName</button>
                                    }
                                    <div class="verso-insert-cell-line"></div>
                                </div>
                            }
                        }

                        <div class="verso-add-cell-row">
                            @foreach (var ct in cellTypes)
                            {
                                var typeId = ct.Id;
                                <button class="verso-add-cell-btn" @onclick="() => HandleAddCell(typeId)">+ @ct.DisplayName Cell</button>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="verso-panel-container">
                @if (_activePanel is not null)
                {
                    <div class="verso-panel-content" @ref="_panelContentEl" style="width:@(_panelWidth)px">
                        <div class="verso-panel-resize-handle" @ref="_resizeHandle"></div>
                        <div class="verso-panel-header">
                            <span class="verso-panel-title">@PanelDisplayName(_activePanel)</span>
                            <button class="verso-panel-minimize" @onclick="CollapsePanel" title="Collapse panel">&#x203A;</button>
                        </div>
                        <div class="verso-panel-body">
                            @if (_activePanel == "metadata")
                            {
                                <MetadataPanel Service="Service" />
                            }
                            else if (_activePanel == "extensions")
                            {
                                <ExtensionPanel Service="Service" />
                            }
                            else if (_activePanel == "variables")
                            {
                                <VariableExplorer Service="Service" />
                            }
                            else if (_activePanel == "settings")
                            {
                                <SettingsPanel Service="Service" />
                            }
                        </div>
                    </div>
                }

                <div class="verso-panel-strip">
                    <button class="verso-panel-strip-tab @(_activePanel == "metadata" ? "verso-panel-strip-tab--active" : "")"
                            @onclick='() => TogglePanel("metadata")' title="Metadata">
                        <svg class="verso-panel-strip-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="1.5" width="10" height="13" rx="1"/>
                            <line x1="5.5" y1="5" x2="10.5" y2="5"/>
                            <line x1="5.5" y1="7.5" x2="10.5" y2="7.5"/>
                            <line x1="5.5" y1="10" x2="8.5" y2="10"/>
                        </svg>
                        <span>Metadata</span>
                    </button>
                    <button class="verso-panel-strip-tab @(_activePanel == "extensions" ? "verso-panel-strip-tab--active" : "")"
                            @onclick='() => TogglePanel("extensions")' title="Extensions">
                        <svg class="verso-panel-strip-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6.5 2.5h3v3h3v3h-3v3h-3v-3h-3v-3h3z"/>
                        </svg>
                        <span>Extensions</span>
                    </button>
                    <button class="verso-panel-strip-tab @(_activePanel == "variables" ? "verso-panel-strip-tab--active" : "")"
                            @onclick='() => TogglePanel("variables")' title="Variables">
                        <svg class="verso-panel-strip-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4.5 2.5c-1.5 0-2 1-2 2s1 1.5 1 2.5-.5 1-1 1.5c.5.5 1 .5 1 1.5s-1 1.5-1 2.5.5 2 2 2"/>
                            <path d="M11.5 2.5c1.5 0 2 1 2 2s-1 1.5-1 2.5.5 1 1 1.5c-.5.5-1 .5-1 1.5s1 1.5 1 2.5-.5 2-2 2"/>
                            <line x1="6.5" y1="6" x2="9.5" y2="10"/>
                            <line x1="6.5" y1="10" x2="9.5" y2="6"/>
                        </svg>
                        <span>Variables</span>
                    </button>
                    <button class="verso-panel-strip-tab @(_activePanel == "settings" ? "verso-panel-strip-tab--active" : "")"
                            @onclick='() => TogglePanel("settings")' title="Settings">
                        <svg class="verso-panel-strip-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="8" cy="8" r="2.5"/>
                            <path d="M8 1.5v2M8 12.5v2M1.5 8h2M12.5 8h2M3.1 3.1l1.4 1.4M11.5 11.5l1.4 1.4M3.1 12.9l1.4-1.4M11.5 4.5l1.4-1.4"/>
                        </svg>
                        <span>Settings</span>
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private Guid? _selectedCellId;
    private Guid? _executingCellId;
    private string? _error;
    private string? _statusMessage;
    private CancellationTokenSource? _statusCts;
    private string? _activePanel;
    private int _panelWidth = 300;
    private DotNetObjectReference<NotebookPage>? _panelResizeRef;
    private ElementReference _resizeHandle;
    private ElementReference _panelContentEl;
    private bool _panelResizeInitialized;
    private bool _showSaveDialog;
    private string _saveFilePath = "";
    private bool _hasNativeHandle;
    private ElementReference _saveDialogInput;

    private string MonacoThemeName =>
        Service.ActiveThemeKind == ThemeKind.Dark ? "vs-dark" : "vs";

    protected override void OnInitialized()
    {
        Service.OnCellExecuted += StateHasChanged;
        Service.OnNotebookChanged += StateHasChanged;
        Service.OnLayoutChanged += StateHasChanged;
        Service.OnThemeChanged += HandleThemeChanged;
        Service.OnExtensionStatusChanged += HandleExtensionStatusChanged;
        Service.OnVariablesChanged += HandleVariablesChanged;
        Service.OnSettingsChanged += HandleSettingsChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await SyncMonacoThemeAsync();

        if (_activePanel is not null && !_panelResizeInitialized)
        {
            _panelResizeInitialized = true;
            _panelResizeRef ??= DotNetObjectReference.Create(this);
            try
            {
                await JS.InvokeVoidAsync("versoPanel.initResize", _resizeHandle, _panelContentEl, _panelResizeRef, 200, 600);
            }
            catch (JSDisconnectedException) { }
            catch (JSException) { }
        }
        else if (_activePanel is null)
        {
            _panelResizeInitialized = false;
        }
    }

    private async void HandleThemeChanged()
    {
        await SyncMonacoThemeAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async void HandleExtensionStatusChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void HandleVariablesChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void HandleSettingsChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task SyncMonacoThemeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("versoMonaco.setTheme", MonacoThemeName);
        }
        catch (JSDisconnectedException) { }
        catch (JSException) { }
    }

    private void TogglePanel(string panelId)
    {
        if (_activePanel == panelId)
            _activePanel = null;
        else
            _activePanel = panelId;
    }

    private void CollapsePanel()
    {
        _activePanel = null;
    }

    private static string PanelDisplayName(string panelId) => panelId switch
    {
        "metadata" => "METADATA",
        "extensions" => "EXTENSIONS",
        "variables" => "VARIABLES",
        "settings" => "SETTINGS",
        _ => panelId.ToUpperInvariant()
    };

    [JSInvokable]
    public void OnPanelResized(int width)
    {
        _panelWidth = width;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleNew()
    {
        try
        {
            _error = null;
            _hasNativeHandle = false;
            try { await JS.InvokeVoidAsync("versoSaveDialog.clearHandle"); } catch { }
            await Service.NewNotebookAsync();
            _selectedCellId = Service.Cells.FirstOrDefault()?.Id;
            await SyncMonacoThemeAsync();
        }
        catch (Exception ex)
        {
            _error = $"Failed to create notebook: {ex.Message}";
        }
    }

    private async Task HandleOpen(string filePath)
    {
        try
        {
            _error = null;
            _hasNativeHandle = false;
            try { await JS.InvokeVoidAsync("versoSaveDialog.clearHandle"); } catch { }
            await Service.OpenAsync(filePath);
            _selectedCellId = Service.Cells.FirstOrDefault()?.Id;
            await SyncMonacoThemeAsync();
        }
        catch (Exception ex)
        {
            _error = $"Failed to open file: {ex.Message}";
        }
    }

    private async Task HandleBrowse((string FileName, string Content) args)
    {
        try
        {
            _error = null;
            _hasNativeHandle = false;
            try { await JS.InvokeVoidAsync("versoSaveDialog.clearHandle"); } catch { }
            await Service.OpenFromContentAsync(args.FileName, args.Content);
            _selectedCellId = Service.Cells.FirstOrDefault()?.Id;
            await SyncMonacoThemeAsync();
        }
        catch (Exception ex)
        {
            _error = $"Failed to open file: {ex.Message}";
        }
    }

    private async Task HandleSave()
    {
        _error = null;

        // Already saved to a known path — save directly
        if (Service.FilePath is not null)
        {
            await SaveToPathAsync(Service.FilePath);
            return;
        }

        // Has a native file handle from a previous Save As — write to it
        if (_hasNativeHandle)
        {
            await SaveViaNativeHandleAsync();
            return;
        }

        // First save — try native OS save dialog, fall back to modal
        var content = await Service.GetSerializedContentAsync();
        if (content is null) return;

        var suggestedName = BuildSuggestedFileName();

        try
        {
            var result = await JS.InvokeAsync<SaveDialogResult>(
                "versoSaveDialog.saveAs", suggestedName, content);

            switch (result.Status)
            {
                case "saved":
                    _hasNativeHandle = true;
                    await ShowStatusAsync($"Saved to {result.FileName}");
                    return;
                case "cancelled":
                    return;
                case "unsupported":
                    // Fall through to modal
                    break;
                default:
                    _error = $"Failed to save: {result.Message}";
                    return;
            }
        }
        catch
        {
            // Fall through to modal
        }

        // Fallback: show in-app modal
        _saveFilePath = System.IO.Path.Combine(Directory.GetCurrentDirectory(), suggestedName);
        _showSaveDialog = true;
        StateHasChanged();
        await Task.Yield();
        try { await _saveDialogInput.FocusAsync(); } catch { }
    }

    private async Task SaveToPathAsync(string path)
    {
        try
        {
            _error = null;

            if (!path.EndsWith(".verso", StringComparison.OrdinalIgnoreCase))
                path = System.IO.Path.ChangeExtension(path, ".verso");

            await Service.SaveAsync(path);
            await ShowStatusAsync($"Saved to {System.IO.Path.GetFileName(path)}");
        }
        catch (Exception ex)
        {
            _error = $"Failed to save: {ex.Message}";
        }
    }

    private async Task SaveViaNativeHandleAsync()
    {
        try
        {
            var content = await Service.GetSerializedContentAsync();
            if (content is null) return;

            var result = await JS.InvokeAsync<SaveDialogResult>(
                "versoSaveDialog.save", content);

            if (result.Status == "saved")
                await ShowStatusAsync($"Saved to {result.FileName}");
            else
                _error = $"Failed to save: {result.Message ?? "unknown error"}";
        }
        catch (Exception ex)
        {
            _error = $"Failed to save: {ex.Message}";
        }
    }

    private string BuildSuggestedFileName()
    {
        var title = Service.Title;
        var name = string.IsNullOrWhiteSpace(title) || title == "Untitled"
            ? "notebook" : title;
        return name + ".verso";
    }

    private async Task ConfirmSaveDialog()
    {
        _showSaveDialog = false;
        if (!string.IsNullOrWhiteSpace(_saveFilePath))
            await SaveToPathAsync(_saveFilePath.Trim());
    }

    private void CancelSaveDialog()
    {
        _showSaveDialog = false;
    }

    private async Task OnSaveDialogKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await ConfirmSaveDialog();
        else if (e.Key == "Escape") CancelSaveDialog();
    }

    private sealed class SaveDialogResult
    {
        public string Status { get; set; } = "";
        public string? FileName { get; set; }
        public string? Message { get; set; }
    }

    private async Task ShowStatusAsync(string message)
    {
        _statusCts?.Cancel();
        _statusCts = new CancellationTokenSource();
        var token = _statusCts.Token;

        _statusMessage = message;
        StateHasChanged();

        try
        {
            await Task.Delay(3000, token);
            _statusMessage = null;
            StateHasChanged();
        }
        catch (TaskCanceledException) { }
    }

    private async Task HandleInsertCell(int index, string type)
    {
        var cell = await Service.InsertCellAsync(index, type);
        _selectedCellId = cell.Id;
    }

    private async Task HandleAddCell(string type)
    {
        var cell = await Service.AddCellAsync(type);
        _selectedCellId = cell.Id;
    }

    private async Task HandleRunCell(Guid cellId)
    {
        _executingCellId = cellId;
        StateHasChanged();

        try
        {
            await Service.ExecuteCellAsync(cellId);
        }
        catch (Exception ex)
        {
            _error = $"Execution error: {ex.Message}";
        }
        finally
        {
            _executingCellId = null;
        }
    }

    private async Task HandleDeleteCell(Guid cellId)
    {
        await Service.RemoveCellAsync(cellId);
        if (_selectedCellId == cellId)
            _selectedCellId = Service.Cells.FirstOrDefault()?.Id;
    }

    private Task HandleSelectCell(Guid cellId)
    {
        _selectedCellId = cellId;
        return Task.CompletedTask;
    }

    private async Task HandleCellAction((Guid CellId, string Action) args)
    {
        var (cellId, action) = args;
        switch (action)
        {
            case "run-and-stay":
                await HandleRunCell(cellId);
                break;
            case "run-and-select-below":
                await HandleRunCell(cellId);
                await SelectNextCell(cellId, addIfLast: true);
                await ScrollToSelectedCell();
                break;
            case "run-and-insert-below":
                await HandleRunCell(cellId);
                await InsertAndSelectBelow(cellId);
                await ScrollToSelectedCell();
                break;
            case "escape":
                _selectedCellId = cellId;
                break;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && e.CtrlKey && e.AltKey)
        {
            await HandleRunAll();
            return;
        }

        if (e.Key == "Escape")
        {
            _selectedCellId = null;
            return;
        }

        if (_selectedCellId is not { } selectedId) return;

        switch (e.Key)
        {
            case "ArrowUp" when e.AltKey:
                await HandleMoveUp(selectedId);
                break;
            case "ArrowDown" when e.AltKey:
                await HandleMoveDown(selectedId);
                break;
            case "ArrowUp":
                SelectPreviousCell(selectedId);
                await ScrollToSelectedCell();
                break;
            case "ArrowDown":
                await SelectNextCell(selectedId);
                await ScrollToSelectedCell();
                break;
            case "Enter" when e.ShiftKey:
                await HandleRunCell(selectedId);
                await SelectNextCell(selectedId, addIfLast: true);
                await ScrollToSelectedCell();
                break;
            case "Enter" when e.CtrlKey:
                await HandleRunCell(selectedId);
                break;
            case "Enter" when e.AltKey:
                await HandleRunCell(selectedId);
                await InsertAndSelectBelow(selectedId);
                await ScrollToSelectedCell();
                break;
            case "Enter":
                await FocusSelectedEditor();
                break;
        }
    }

    private async Task HandleRunAll()
    {
        var cells = Service.Cells;
        foreach (var cell in cells.ToList())
        {
            if (cell.Type == "code")
                await HandleRunCell(cell.Id);
        }
    }

    private async Task SelectNextCell(Guid currentId, bool addIfLast = false)
    {
        var cells = Service.Cells;
        var cellList = cells.ToList();
        var index = cellList.FindIndex(c => c.Id == currentId);
        if (index < 0) return;

        if (index < cellList.Count - 1)
        {
            _selectedCellId = cellList[index + 1].Id;
        }
        else if (addIfLast)
        {
            var newCell = await Service.AddCellAsync("code");
            _selectedCellId = newCell.Id;
        }
    }

    private void SelectPreviousCell(Guid currentId)
    {
        var cells = Service.Cells;
        var cellList = cells.ToList();
        var index = cellList.FindIndex(c => c.Id == currentId);
        if (index > 0)
            _selectedCellId = cellList[index - 1].Id;
    }

    private async Task InsertAndSelectBelow(Guid currentId)
    {
        var cells = Service.Cells;
        var cellList = cells.ToList();
        var index = cellList.FindIndex(c => c.Id == currentId);
        if (index < 0) return;

        var newCell = await Service.InsertCellAsync(index + 1, "code");
        _selectedCellId = newCell.Id;
    }

    private async Task ScrollToSelectedCell()
    {
        if (_selectedCellId is null) return;
        StateHasChanged();
        await Task.Yield();
        try
        {
            await JS.InvokeVoidAsync("versoMonaco.scrollToSelected");
        }
        catch (JSDisconnectedException) { }
        catch (JSException) { }
    }

    private async Task FocusSelectedEditor()
    {
        if (_selectedCellId is null) return;
        try
        {
            await JS.InvokeVoidAsync("versoMonaco.focusByContainer",
                $".verso-cell--selected .verso-cell-editor");
        }
        catch (JSDisconnectedException) { }
        catch (JSException) { }
    }

    private void HandleCellListClick()
    {
        _selectedCellId = null;
    }

    private async Task HandleMoveUp(Guid cellId)
    {
        var cells = Service.Cells;
        var index = cells.ToList().FindIndex(c => c.Id == cellId);
        if (index > 0) await Service.MoveCellAsync(index, index - 1);
    }

    private async Task HandleMoveDown(Guid cellId)
    {
        var cells = Service.Cells;
        var cellList = cells.ToList();
        var index = cellList.FindIndex(c => c.Id == cellId);
        if (index >= 0 && index < cellList.Count - 1) await Service.MoveCellAsync(index, index + 1);
    }

    private async Task HandleSourceChanged((Guid CellId, string Source) args)
    {
        await Service.UpdateCellSourceAsync(args.CellId, args.Source);
    }

    private async Task HandleCellTypeChanged((Guid CellId, string NewType) args)
    {
        await Service.ChangeCellTypeAsync(args.CellId, args.NewType);
    }

    private async Task HandleActionExecuted(string actionId)
    {
        if (string.Equals(actionId, "verso.action.run-all", StringComparison.OrdinalIgnoreCase))
            _selectedCellId = null;

        if (string.Equals(actionId, "verso.action.restart-kernel", StringComparison.OrdinalIgnoreCase))
            await ShowStatusAsync("Kernel restarted");

        StateHasChanged();
    }

    private Task HandleError(string message)
    {
        _error = message;
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _statusCts?.Cancel();
        _statusCts?.Dispose();
        _panelResizeRef?.Dispose();
        Service.OnCellExecuted -= StateHasChanged;
        Service.OnNotebookChanged -= StateHasChanged;
        Service.OnLayoutChanged -= StateHasChanged;
        Service.OnThemeChanged -= HandleThemeChanged;
        Service.OnExtensionStatusChanged -= HandleExtensionStatusChanged;
        Service.OnVariablesChanged -= HandleVariablesChanged;
        Service.OnSettingsChanged -= HandleSettingsChanged;
    }
}
