@page "/"
@implements IDisposable
@inject NotebookService Service
@inject IJSRuntime JS

<PageTitle>Verso Notebook</PageTitle>

<ThemeProvider ThemeEngine="@Service.Scaffold?.ThemeEngine" />

<div class="verso-notebook"
     tabindex="0" @onkeydown="HandleKeyDown">
    <Toolbar Service="Service"
             SelectedCellId="_selectedCellId"
             OnNewNotebook="HandleNew"
             OnOpenNotebook="HandleOpen"
             OnBrowseNotebook="HandleBrowse"
             OnSaveNotebook="HandleSave"
             OnAddCell="HandleAddCell"
             OnActionExecuted="HandleActionExecuted"
             OnError="HandleError" />

    @if (_error is not null)
    {
        <div class="verso-error-banner">
            <span>@_error</span>
            <button @onclick="() => _error = null">Dismiss</button>
        </div>
    }

    @if (_statusMessage is not null)
    {
        <div class="verso-status-banner">
            <span>@_statusMessage</span>
        </div>
    }

    @if (!Service.IsLoaded)
    {
        <div class="verso-welcome">
            <h1>Verso Notebook</h1>
            <p>Create a new notebook or open an existing <code>.verso</code> or <code>.ipynb</code> file to get started.</p>
            <button class="verso-welcome-btn" @onclick="HandleNew">New Notebook</button>
        </div>
    }
    else
    {
        <div class="verso-notebook-body">
            <div class="verso-notebook-main">
                @if (IsDashboardLayout)
                {
                    <DashboardGrid Service="Service"
                                   Cells="Service.Scaffold!.Cells"
                                   ExecutingCellId="_executingCellId"
                                   OnRunCell="HandleRunCell"
                                   OnSourceChanged="HandleSourceChanged" />
                }
                else
                {
                    <div class="verso-cell-list" @onclick="HandleCellListClick">
                        @{ var cells = Service.Scaffold!.Cells; }
                        @for (int i = 0; i < cells.Count; i++)
                        {
                            var cell = cells[i];
                            var index = i;
                            <div @onclick:stopPropagation="true">
                                <Cell CellData="cell"
                                      IsSelected="cell.Id == _selectedCellId"
                                      IsExecuting="cell.Id == _executingCellId"
                                      Index="index"
                                      IsLast="index == cells.Count - 1"
                                      CollapsesInput="ShouldCollapseInput(cell)"
                                      OnRunCell="HandleRunCell"
                                      OnDeleteCell="HandleDeleteCell"
                                      OnSelect="HandleSelectCell"
                                      OnMoveUp="HandleMoveUp"
                                      OnMoveDown="HandleMoveDown"
                                      OnSourceChanged="HandleSourceChanged"
                                      OnCellAction="HandleCellAction"
                                      OnCellTypeChanged="HandleCellTypeChanged" />
                            </div>

                            @if (index < cells.Count - 1)
                            {
                                var insertIndex = index + 1;
                                <div class="verso-insert-cell-row @(cell.Id == _selectedCellId ? "verso-insert-cell-row--visible" : "")">
                                    <div class="verso-insert-cell-line"></div>
                                    <button class="verso-insert-cell-btn" @onclick='() => HandleInsertCell(insertIndex, "code")'>+ Code</button>
                                    <button class="verso-insert-cell-btn" @onclick='() => HandleInsertCell(insertIndex, "markdown")'>+ Markdown</button>
                                    <div class="verso-insert-cell-line"></div>
                                </div>
                            }
                        }

                        <div class="verso-add-cell-row">
                            <button class="verso-add-cell-btn" @onclick='() => HandleAddCell("code")'>+ Code Cell</button>
                            <button class="verso-add-cell-btn" @onclick='() => HandleAddCell("markdown")'>+ Markdown Cell</button>
                        </div>
                    </div>
                }
            </div>

            <div class="verso-panel-container">
                @if (_activePanel is not null)
                {
                    <div class="verso-panel-content" @ref="_panelContentEl" style="width:@(_panelWidth)px">
                        <div class="verso-panel-resize-handle" @ref="_resizeHandle"></div>
                        <div class="verso-panel-header">
                            <span class="verso-panel-title">@PanelDisplayName(_activePanel)</span>
                            <button class="verso-panel-minimize" @onclick="CollapsePanel" title="Collapse panel">&#x203A;</button>
                        </div>
                        <div class="verso-panel-body">
                            @if (_activePanel == "metadata")
                            {
                                <MetadataPanel Service="Service" />
                            }
                            else if (_activePanel == "extensions")
                            {
                                <ExtensionPanel Service="Service" />
                            }
                            else if (_activePanel == "variables")
                            {
                                <VariableExplorer Service="Service" />
                            }
                            else if (_activePanel == "settings")
                            {
                                <SettingsPanel Service="Service" />
                            }
                        </div>
                    </div>
                }

                <div class="verso-panel-strip">
                    <button class="verso-panel-strip-tab @(_activePanel == "metadata" ? "verso-panel-strip-tab--active" : "")"
                            @onclick='() => TogglePanel("metadata")' title="Metadata">
                        <svg class="verso-panel-strip-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="1.5" width="10" height="13" rx="1"/>
                            <line x1="5.5" y1="5" x2="10.5" y2="5"/>
                            <line x1="5.5" y1="7.5" x2="10.5" y2="7.5"/>
                            <line x1="5.5" y1="10" x2="8.5" y2="10"/>
                        </svg>
                        <span>Metadata</span>
                    </button>
                    <button class="verso-panel-strip-tab @(_activePanel == "extensions" ? "verso-panel-strip-tab--active" : "")"
                            @onclick='() => TogglePanel("extensions")' title="Extensions">
                        <svg class="verso-panel-strip-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6.5 2.5h3v3h3v3h-3v3h-3v-3h-3v-3h3z"/>
                        </svg>
                        <span>Extensions</span>
                    </button>
                    <button class="verso-panel-strip-tab @(_activePanel == "variables" ? "verso-panel-strip-tab--active" : "")"
                            @onclick='() => TogglePanel("variables")' title="Variables">
                        <svg class="verso-panel-strip-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4.5 2.5c-1.5 0-2 1-2 2s1 1.5 1 2.5-.5 1-1 1.5c.5.5 1 .5 1 1.5s-1 1.5-1 2.5.5 2 2 2"/>
                            <path d="M11.5 2.5c1.5 0 2 1 2 2s-1 1.5-1 2.5.5 1 1 1.5c-.5.5-1 .5-1 1.5s1 1.5 1 2.5-.5 2-2 2"/>
                            <line x1="6.5" y1="6" x2="9.5" y2="10"/>
                            <line x1="6.5" y1="10" x2="9.5" y2="6"/>
                        </svg>
                        <span>Variables</span>
                    </button>
                    <button class="verso-panel-strip-tab @(_activePanel == "settings" ? "verso-panel-strip-tab--active" : "")"
                            @onclick='() => TogglePanel("settings")' title="Settings">
                        <svg class="verso-panel-strip-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="8" cy="8" r="2.5"/>
                            <path d="M8 1.5v2M8 12.5v2M1.5 8h2M12.5 8h2M3.1 3.1l1.4 1.4M11.5 11.5l1.4 1.4M3.1 12.9l1.4-1.4M11.5 4.5l1.4-1.4"/>
                        </svg>
                        <span>Settings</span>
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private Guid? _selectedCellId;
    private Guid? _executingCellId;
    private string? _error;
    private string? _statusMessage;
    private CancellationTokenSource? _statusCts;
    private string? _activePanel;
    private int _panelWidth = 300;
    private DotNetObjectReference<NotebookPage>? _panelResizeRef;
    private ElementReference _resizeHandle;
    private ElementReference _panelContentEl;
    private bool _panelResizeInitialized;

    private bool ShouldCollapseInput(CellModel cell)
    {
        var renderer = Service.ExtensionHost?.GetRenderers()
            .FirstOrDefault(r => string.Equals(r.CellTypeId, cell.Type, StringComparison.OrdinalIgnoreCase));
        return renderer?.CollapsesInputOnExecute ?? false;
    }

    private bool IsDashboardLayout =>
        Service.Scaffold?.LayoutManager?.ActiveLayout?.RequiresCustomRenderer == true;

    private string MonacoThemeName =>
        Service.Scaffold?.ThemeEngine?.ActiveTheme?.ThemeKind == Verso.Abstractions.ThemeKind.Dark
            ? "vs-dark" : "vs";

    protected override void OnInitialized()
    {
        Service.OnCellExecuted += StateHasChanged;
        Service.OnNotebookChanged += StateHasChanged;
        Service.OnLayoutChanged += StateHasChanged;
        Service.OnThemeChanged += HandleThemeChanged;
        Service.OnExtensionStatusChanged += HandleExtensionStatusChanged;
        Service.OnVariablesChanged += HandleVariablesChanged;
        Service.OnSettingsChanged += HandleSettingsChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await SyncMonacoThemeAsync();

        if (_activePanel is not null && !_panelResizeInitialized)
        {
            _panelResizeInitialized = true;
            _panelResizeRef ??= DotNetObjectReference.Create(this);
            try
            {
                await JS.InvokeVoidAsync("versoPanel.initResize", _resizeHandle, _panelContentEl, _panelResizeRef, 200, 600);
            }
            catch (JSDisconnectedException) { }
            catch (JSException) { }
        }
        else if (_activePanel is null)
        {
            _panelResizeInitialized = false;
        }
    }

    private async void HandleThemeChanged()
    {
        await SyncMonacoThemeAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async void HandleExtensionStatusChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void HandleVariablesChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void HandleSettingsChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task SyncMonacoThemeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("versoMonaco.setTheme", MonacoThemeName);
        }
        catch (JSDisconnectedException) { }
        catch (JSException) { }
    }

    private void TogglePanel(string panelId)
    {
        if (_activePanel == panelId)
            _activePanel = null;
        else
            _activePanel = panelId;
    }

    private void CollapsePanel()
    {
        _activePanel = null;
    }

    private static string PanelDisplayName(string panelId) => panelId switch
    {
        "metadata" => "METADATA",
        "extensions" => "EXTENSIONS",
        "variables" => "VARIABLES",
        "settings" => "SETTINGS",
        _ => panelId.ToUpperInvariant()
    };

    [JSInvokable]
    public void OnPanelResized(int width)
    {
        _panelWidth = width;
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleNew()
    {
        try
        {
            _error = null;
            await Service.NewNotebookAsync();
            _selectedCellId = Service.Scaffold?.Cells.FirstOrDefault()?.Id;
            await SyncMonacoThemeAsync();
        }
        catch (Exception ex)
        {
            _error = $"Failed to create notebook: {ex.Message}";
        }
    }

    private async Task HandleOpen(string filePath)
    {
        try
        {
            _error = null;
            await Service.OpenAsync(filePath);
            _selectedCellId = Service.Scaffold?.Cells.FirstOrDefault()?.Id;
            await SyncMonacoThemeAsync();
        }
        catch (Exception ex)
        {
            _error = $"Failed to open file: {ex.Message}";
        }
    }

    private async Task HandleBrowse((string FileName, string Content) args)
    {
        try
        {
            _error = null;
            await Service.OpenFromContentAsync(args.FileName, args.Content);
            _selectedCellId = Service.Scaffold?.Cells.FirstOrDefault()?.Id;
            await SyncMonacoThemeAsync();
        }
        catch (Exception ex)
        {
            _error = $"Failed to open file: {ex.Message}";
        }
    }

    private async Task HandleSave()
    {
        try
        {
            _error = null;
            var path = Service.FilePath ?? "notebook.verso";

            // Always save as .verso — don't overwrite imported formats like .ipynb
            if (!path.EndsWith(".verso", StringComparison.OrdinalIgnoreCase))
                path = System.IO.Path.ChangeExtension(path, ".verso");

            await Service.SaveAsync(path);
            await ShowStatusAsync($"Saved to {System.IO.Path.GetFileName(path)}");
        }
        catch (Exception ex)
        {
            _error = $"Failed to save: {ex.Message}";
        }
    }

    private async Task ShowStatusAsync(string message)
    {
        _statusCts?.Cancel();
        _statusCts = new CancellationTokenSource();
        var token = _statusCts.Token;

        _statusMessage = message;
        StateHasChanged();

        try
        {
            await Task.Delay(3000, token);
            _statusMessage = null;
            StateHasChanged();
        }
        catch (TaskCanceledException) { }
    }

    private Task HandleInsertCell(int index, string type)
    {
        var cell = Service.InsertCell(index, type);
        _selectedCellId = cell.Id;
        return Task.CompletedTask;
    }

    private Task HandleAddCell(string type)
    {
        var cell = Service.AddCell(type);
        _selectedCellId = cell.Id;
        return Task.CompletedTask;
    }

    private async Task HandleRunCell(Guid cellId)
    {
        _executingCellId = cellId;
        StateHasChanged();

        try
        {
            await Service.ExecuteCellAsync(cellId);
        }
        catch (Exception ex)
        {
            _error = $"Execution error: {ex.Message}";
        }
        finally
        {
            _executingCellId = null;
        }
    }

    private Task HandleDeleteCell(Guid cellId)
    {
        Service.RemoveCell(cellId);
        if (_selectedCellId == cellId)
            _selectedCellId = Service.Scaffold?.Cells.FirstOrDefault()?.Id;
        return Task.CompletedTask;
    }

    private Task HandleSelectCell(Guid cellId)
    {
        _selectedCellId = cellId;
        return Task.CompletedTask;
    }

    private async Task HandleCellAction((Guid CellId, string Action) args)
    {
        var (cellId, action) = args;
        switch (action)
        {
            case "run-and-stay":
                await HandleRunCell(cellId);
                break;
            case "run-and-select-below":
                await HandleRunCell(cellId);
                SelectNextCell(cellId, addIfLast: true);
                break;
            case "run-and-insert-below":
                await HandleRunCell(cellId);
                InsertAndSelectBelow(cellId);
                break;
            case "escape":
                _selectedCellId = cellId;
                break;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // Ctrl+Alt+Enter → run all (works with or without selection)
        if (e.Key == "Enter" && e.CtrlKey && e.AltKey)
        {
            await HandleRunAll();
            return;
        }

        if (e.Key == "Escape")
        {
            _selectedCellId = null;
            return;
        }

        // All remaining shortcuts require a selected cell
        if (_selectedCellId is not { } selectedId) return;

        switch (e.Key)
        {
            case "ArrowUp" when e.AltKey:
                await HandleMoveUp(selectedId);
                break;
            case "ArrowDown" when e.AltKey:
                await HandleMoveDown(selectedId);
                break;
            case "ArrowUp":
                SelectPreviousCell(selectedId);
                break;
            case "ArrowDown":
                SelectNextCell(selectedId);
                break;
            case "Enter" when e.ShiftKey:
                await HandleRunCell(selectedId);
                SelectNextCell(selectedId, addIfLast: true);
                break;
            case "Enter" when e.CtrlKey:
                await HandleRunCell(selectedId);
                break;
            case "Enter" when e.AltKey:
                await HandleRunCell(selectedId);
                InsertAndSelectBelow(selectedId);
                break;
            case "Enter":
                await FocusSelectedEditor();
                break;
        }
    }

    private async Task HandleRunAll()
    {
        var cells = Service.Scaffold?.Cells;
        if (cells is null) return;

        foreach (var cell in cells.ToList())
        {
            if (cell.Type == "code")
                await HandleRunCell(cell.Id);
        }
    }

    private void SelectNextCell(Guid currentId, bool addIfLast = false)
    {
        var cells = Service.Scaffold?.Cells;
        if (cells is null) return;
        var cellList = cells.ToList();
        var index = cellList.FindIndex(c => c.Id == currentId);
        if (index < 0) return;

        if (index < cellList.Count - 1)
        {
            _selectedCellId = cellList[index + 1].Id;
        }
        else if (addIfLast)
        {
            var newCell = Service.AddCell("code");
            _selectedCellId = newCell.Id;
        }
    }

    private void SelectPreviousCell(Guid currentId)
    {
        var cells = Service.Scaffold?.Cells;
        if (cells is null) return;
        var cellList = cells.ToList();
        var index = cellList.FindIndex(c => c.Id == currentId);
        if (index > 0)
            _selectedCellId = cellList[index - 1].Id;
    }

    private void InsertAndSelectBelow(Guid currentId)
    {
        var cells = Service.Scaffold?.Cells;
        if (cells is null) return;
        var cellList = cells.ToList();
        var index = cellList.FindIndex(c => c.Id == currentId);
        if (index < 0) return;

        var newCell = Service.InsertCell(index + 1, "code");
        _selectedCellId = newCell.Id;
    }

    private async Task FocusSelectedEditor()
    {
        if (_selectedCellId is null) return;
        try
        {
            // Find the Monaco editor within the selected cell's container
            await JS.InvokeVoidAsync("versoMonaco.focusByContainer",
                $".verso-cell--selected .verso-cell-editor");
        }
        catch (JSDisconnectedException) { }
        catch (JSException) { }
    }

    private void HandleCellListClick()
    {
        _selectedCellId = null;
    }

    private Task HandleMoveUp(Guid cellId)
    {
        var cells = Service.Scaffold?.Cells;
        if (cells is null) return Task.CompletedTask;
        var index = cells.ToList().FindIndex(c => c.Id == cellId);
        if (index > 0) Service.MoveCellAsync(index, index - 1);
        return Task.CompletedTask;
    }

    private Task HandleMoveDown(Guid cellId)
    {
        var cells = Service.Scaffold?.Cells;
        if (cells is null) return Task.CompletedTask;
        var cellList = cells.ToList();
        var index = cellList.FindIndex(c => c.Id == cellId);
        if (index >= 0 && index < cellList.Count - 1) Service.MoveCellAsync(index, index + 1);
        return Task.CompletedTask;
    }

    private Task HandleSourceChanged((Guid CellId, string Source) args)
    {
        Service.UpdateCellSource(args.CellId, args.Source);
        return Task.CompletedTask;
    }

    private void HandleCellTypeChanged((Guid CellId, string NewType) args)
    {
        Service.ChangeCellType(args.CellId, args.NewType);
    }

    private async Task HandleActionExecuted(string actionId)
    {
        if (string.Equals(actionId, "verso.action.run-all", StringComparison.OrdinalIgnoreCase))
            _selectedCellId = null;

        if (string.Equals(actionId, "verso.action.restart-kernel", StringComparison.OrdinalIgnoreCase))
            await ShowStatusAsync("Kernel restarted");

        StateHasChanged();
    }

    private Task HandleError(string message)
    {
        _error = message;
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _statusCts?.Cancel();
        _statusCts?.Dispose();
        _panelResizeRef?.Dispose();
        Service.OnCellExecuted -= StateHasChanged;
        Service.OnNotebookChanged -= StateHasChanged;
        Service.OnLayoutChanged -= StateHasChanged;
        Service.OnThemeChanged -= HandleThemeChanged;
        Service.OnExtensionStatusChanged -= HandleExtensionStatusChanged;
        Service.OnVariablesChanged -= HandleVariablesChanged;
        Service.OnSettingsChanged -= HandleSettingsChanged;
    }
}
