@using Verso.Contexts
@using Verso.Extensions

<div class="verso-sidebar-panel">
    <div class="verso-variable-toolbar">
        <button class="verso-cell-btn" title="Refresh" @onclick="Refresh">&#8635;</button>
    </div>

    @if (_entries.Count == 0)
    {
        <div class="verso-variable-empty">No variables defined.</div>
    }
    else
    {
        <table class="verso-variable-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entry in _entries)
                {
                    var v = entry;
                    <tr class="verso-variable-row @(_inspecting == v.Name ? "verso-variable-row--selected" : "")"
                        @onclick="() => InspectAsync(v.Name)">
                        <td>@v.Name</td>
                        <td>@v.TypeName</td>
                        <td class="verso-variable-preview">@v.ValuePreview</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (_inspectContent is not null)
    {
        <div class="verso-variable-inspect-panel">
            <div class="verso-variable-inspect-header">
                <span>@_inspecting</span>
                <button class="verso-cell-btn" @onclick="CloseInspect">&#10005;</button>
            </div>
            <div class="verso-variable-inspect-body">
                @if (_inspectMimeType == "text/html")
                {
                    @((MarkupString)_inspectContent)
                }
                else
                {
                    <pre>@_inspectContent</pre>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public NotebookService Service { get; set; } = default!;

    private List<VariableExplorerEntry> _entries = new();
    private string? _inspecting;
    private string? _inspectContent;
    private string _inspectMimeType = "text/plain";

    protected override void OnParametersSet()
    {
        Refresh();
    }

    private void Refresh()
    {
        if (Service?.Scaffold is null || Service.ExtensionHost is null)
        {
            _entries = new();
            return;
        }

        var previewService = new VariablePreviewService(Service.ExtensionHost);
        var variables = Service.Scaffold.Variables.GetAll();

        _entries = variables.Where(v => !v.Name.StartsWith("__")).Select(v => new VariableExplorerEntry(
            v.Name,
            v.Type.Name,
            previewService.GetPreview(v.Value),
            v.Value is not null && v.Value is not string && (v.Value is System.Collections.IEnumerable || v.Value.GetType().GetProperties().Length > 0)
        )).ToList();
    }

    private async Task InspectAsync(string name)
    {
        if (Service?.Scaffold is null || Service.ExtensionHost is null) return;

        _inspecting = name;

        var variables = Service.Scaffold.Variables;
        var all = variables.GetAll();
        var descriptor = all.FirstOrDefault(v =>
            string.Equals(v.Name, name, StringComparison.OrdinalIgnoreCase));

        if (descriptor?.Value is null)
        {
            _inspectContent = "null";
            _inspectMimeType = "text/plain";
            return;
        }

        // Try formatters
        var formatters = Service.ExtensionHost.GetFormatters();
        var context = new SimpleFormatterContext(Service.ExtensionHost, variables);

        foreach (var formatter in formatters.OrderByDescending(f => f.Priority))
        {
            if (formatter.CanFormat(descriptor.Value, context))
            {
                try
                {
                    var output = await formatter.FormatAsync(descriptor.Value, context);
                    _inspectMimeType = output.MimeType;
                    _inspectContent = output.Content;
                    return;
                }
                catch { /* fall through */ }
            }
        }

        _inspectMimeType = "text/plain";
        _inspectContent = descriptor.Value.ToString() ?? "null";
    }

    private void CloseInspect()
    {
        _inspecting = null;
        _inspectContent = null;
    }
}
