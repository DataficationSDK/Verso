@implements IAsyncDisposable
@inject IJSRuntime JS

<div id="@_elementId" class="verso-monaco-editor"></div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string Language { get; set; } = "csharp";
    [Parameter] public bool ReadOnly { get; set; }
    [Parameter] public EventCallback<string> OnValueChanged { get; set; }
    [Parameter] public Func<string, int, Task<object?>>? OnGetHoverInfo { get; set; }
    [Parameter] public Func<string, int, Task<object?>>? OnGetCompletions { get; set; }
    [Parameter] public EventCallback<string> OnEditorAction { get; set; }

    private readonly string _elementId = $"monaco-{Guid.NewGuid():N}";
    private DotNetObjectReference<MonacoEditor>? _dotnetRef;
    private bool _initialized;
    private string? _lastSetValue;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotnetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("versoMonaco.create", _elementId, new
            {
                value = Value,
                language = Language,
                readOnly = ReadOnly
            }, _dotnetRef);
            _initialized = true;
            _lastSetValue = Value;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_initialized) return;

        if (Value != _lastSetValue)
        {
            _lastSetValue = Value;
            await JS.InvokeVoidAsync("versoMonaco.setValue", _elementId, Value);
        }

        await JS.InvokeVoidAsync("versoMonaco.setLanguage", _elementId, Language);
    }

    [JSInvokable]
    public async Task OnContentChanged(string newValue)
    {
        _lastSetValue = newValue;
        await ValueChanged.InvokeAsync(newValue);
        await OnValueChanged.InvokeAsync(newValue);
    }

    [JSInvokable]
    public async Task OnEditorActionShortcut(string action)
    {
        await OnEditorAction.InvokeAsync(action);
    }

    [JSInvokable]
    public async Task<object?> GetHoverInfo(string code, int cursorPosition)
    {
        try
        {
            return OnGetHoverInfo is not null
                ? await OnGetHoverInfo(code, cursorPosition)
                : null;
        }
        catch { return null; }
    }

    [JSInvokable]
    public async Task<object?> GetCompletions(string code, int cursorPosition)
    {
        try
        {
            return OnGetCompletions is not null
                ? await OnGetCompletions(code, cursorPosition)
                : null;
        }
        catch { return null; }
    }

    public async ValueTask DisposeAsync()
    {
        if (_initialized)
        {
            try
            {
                await JS.InvokeVoidAsync("versoMonaco.dispose", _elementId);
            }
            catch (JSDisconnectedException) { }
        }
        _dotnetRef?.Dispose();
    }
}
