<div class="verso-toolbar">
    @if (!Service.IsEmbedded)
    {
        <div class="verso-toolbar-group">
            <button class="verso-toolbar-btn" @onclick="OnNew" title="New Notebook">
                <svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 2H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V6z"/><path d="M9 2v4h4"/><line x1="8" y1="9" x2="8" y2="13"/><line x1="6" y1="11" x2="10" y2="11"/></svg>
                New
            </button>
            <button class="verso-toolbar-btn" @onclick="OnOpenClick" title="Open File">
                <svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4v9a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H8L6.5 3.5 6 3H3a1 1 0 0 0-1 1z"/></svg>
                Open
            </button>
        </div>

        @if (_showOpenInput)
        {
            <div class="verso-toolbar-group">
                <input class="verso-toolbar-input" @bind="_openFilePath" @bind:event="oninput" placeholder="File path or URL..." @onkeydown="OnOpenKeyDown" />
                <button class="verso-toolbar-btn" @onclick="OnOpenFile">Go</button>
                <label class="verso-toolbar-btn verso-toolbar-btn--browse">
                    Browse
                    <InputFile accept=".verso,.ipynb" OnChange="OnFileSelected" style="display:none" />
                </label>
                <button class="verso-toolbar-btn" @onclick="() => _showOpenInput = false">Cancel</button>
            </div>
        }
    }

    @if (Service.IsLoaded)
    {
        @if (!Service.IsEmbedded)
        {
            <div class="verso-toolbar-separator"></div>
        }

        <button class="verso-toolbar-btn" @onclick="OnSave" title="Save">
            <svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2h8l2 2v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/><path d="M5 2v3h4V2"/><path d="M5 10h6v4H5z"/></svg>
            Save
        </button>

        <div class="verso-toolbar-separator"></div>

        @foreach (var action in _filteredToolbarActions)
        {
            var a = action;
            var isEnabled = _enabledStates.GetValueOrDefault(a.ActionId, false);
            <button class="verso-toolbar-btn"
                    disabled="@(!isEnabled)"
                    title="@a.DisplayName"
                    @onclick="() => ExecuteActionAsync(a)">
                @if (a.Icon is not null)
                {
                    @((MarkupString)a.Icon)
                }
                @a.DisplayName
            </button>
        }

        <div class="verso-toolbar-separator"></div>

        <div class="verso-toolbar-group">
            <button class="verso-toolbar-btn" @onclick="OnAddCodeCell" title="Add Code Cell">+ Code</button>
            <button class="verso-toolbar-btn" @onclick="OnAddMarkdownCell" title="Add Markdown Cell">+ Markdown</button>
        </div>

        @if (Service.AvailableLayouts.Count > 1)
        {
            <div class="verso-toolbar-separator"></div>

            <div class="verso-toolbar-dropdown" @onfocusout="OnLayoutDropdownFocusOut" tabindex="-1">
                <button class="verso-toolbar-btn"
                        title="Switch Layout"
                        @onclick="CycleLayout">
                    <svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><rect x="1.5" y="1.5" width="13" height="13" rx="1"/><line x1="6" y1="1.5" x2="6" y2="14.5"/><line x1="6" y1="8" x2="14.5" y2="8"/></svg>
                    @ActiveLayoutName
                </button>
                <button class="verso-toolbar-btn verso-toolbar-dropdown-chevron"
                        @onclick="ToggleLayoutDropdown"
                        @onclick:stopPropagation="true">
                    &#9662;
                </button>
                @if (_showLayoutDropdown)
                {
                    <div class="verso-toolbar-dropdown-popup">
                        @foreach (var layout in Service.AvailableLayouts)
                        {
                            var l = layout;
                            var isActive = string.Equals(l.LayoutId, Service.ActiveLayoutId, StringComparison.OrdinalIgnoreCase);
                            <button class="verso-toolbar-btn @(isActive ? "verso-toolbar-btn--active" : "")"
                                    @onclick="() => SelectLayout(l.LayoutId)">
                                @l.DisplayName
                            </button>
                        }
                    </div>
                }
            </div>
        }

        @if (Service.AvailableThemes.Count > 1 && !Service.IsEmbedded)
        {
            <div class="verso-toolbar-separator"></div>

            <div class="verso-toolbar-dropdown" @onfocusout="OnThemeDropdownFocusOut" tabindex="-1">
                <button class="verso-toolbar-btn"
                        title="Switch Theme"
                        @onclick="CycleTheme">
                    <svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.3"><circle cx="8" cy="8" r="6"/><circle cx="5.5" cy="6" r="1" fill="currentColor" stroke="none"/><circle cx="8" cy="4.5" r="1" fill="currentColor" stroke="none"/><circle cx="10.5" cy="6" r="1" fill="currentColor" stroke="none"/><circle cx="6" cy="10" r="1" fill="currentColor" stroke="none"/></svg>
                    @ActiveThemeName
                </button>
                <button class="verso-toolbar-btn verso-toolbar-dropdown-chevron"
                        @onclick="ToggleThemeDropdown"
                        @onclick:stopPropagation="true">
                    &#9662;
                </button>
                @if (_showThemeDropdown)
                {
                    <div class="verso-toolbar-dropdown-popup">
                        @foreach (var theme in Service.AvailableThemes)
                        {
                            var t = theme;
                            var isActive = string.Equals(t.ThemeId, Service.ActiveThemeId, StringComparison.OrdinalIgnoreCase);
                            <button class="verso-toolbar-btn @(isActive ? "verso-toolbar-btn--active" : "")"
                                    @onclick="() => SelectTheme(t.ThemeId)">
                                @t.DisplayName
                            </button>
                        }
                    </div>
                }
            </div>
        }

        @if (_exportActions.Count > 0 && !Service.IsEmbedded)
        {
            <div class="verso-toolbar-separator"></div>

            <div class="verso-toolbar-dropdown" @onfocusout="OnExportDropdownFocusOut" tabindex="-1">
                <button class="verso-toolbar-btn"
                        title="Export Notebook"
                        @onclick="ToggleExportDropdown">
                    <svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><path d="M14 10v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-3"/><polyline points="5.5 5 8 2.5 10.5 5"/><line x1="8" y1="2.5" x2="8" y2="10"/></svg>
                    Export &#9662;
                </button>
                @if (_showExportDropdown)
                {
                    <div class="verso-toolbar-dropdown-popup">
                        @foreach (var action in _exportActions)
                        {
                            var a = action;
                            var isEnabled = _enabledStates.GetValueOrDefault(a.ActionId, false);
                            <button class="verso-toolbar-btn"
                                    disabled="@(!isEnabled)"
                                    @onclick="() => ExecuteExportAsync(a)">
                                @a.DisplayName
                            </button>
                        }
                    </div>
                }
            </div>
        }

    }
</div>

@code {
    [Parameter] public INotebookService Service { get; set; } = default!;
    [Parameter] public Guid? SelectedCellId { get; set; }
    [Parameter] public EventCallback OnNewNotebook { get; set; }
    [Parameter] public EventCallback<string> OnOpenNotebook { get; set; }
    [Parameter] public EventCallback<(string FileName, string Content)> OnBrowseNotebook { get; set; }
    [Parameter] public EventCallback OnSaveNotebook { get; set; }
    [Parameter] public EventCallback<string> OnAddCell { get; set; }
    [Parameter] public EventCallback<string> OnActionExecuted { get; set; }
    [Parameter] public EventCallback<string> OnError { get; set; }

    private List<ToolbarActionInfo> _filteredToolbarActions = new();
    private List<ToolbarActionInfo> _exportActions = new();
    private Dictionary<string, bool> _enabledStates = new();
    private bool _showOpenInput;
    private string _openFilePath = "";
    private bool _showLayoutDropdown;
    private bool _showThemeDropdown;
    private bool _showExportDropdown;

    private static readonly HashSet<string> _excludedActionIds = new(StringComparer.OrdinalIgnoreCase)
    {
        "verso.switchLayout",
        "verso.switchTheme",
        "verso.action.export-html",
        "verso.action.export-markdown"
    };

    private static readonly HashSet<string> _exportActionIds = new(StringComparer.OrdinalIgnoreCase)
    {
        "verso.action.export-html",
        "verso.action.export-markdown"
    };

    private string ActiveLayoutName =>
        Service.AvailableLayouts.FirstOrDefault(l => string.Equals(l.LayoutId, Service.ActiveLayoutId, StringComparison.OrdinalIgnoreCase))?.DisplayName ?? "Layout";

    private string ActiveThemeName =>
        Service.AvailableThemes.FirstOrDefault(t => string.Equals(t.ThemeId, Service.ActiveThemeId, StringComparison.OrdinalIgnoreCase))?.DisplayName ?? "Theme";

    protected override async Task OnParametersSetAsync()
    {
        if (Service.IsLoaded)
        {
            var allMainActions = Service.GetToolbarActions(ToolbarPlacement.MainToolbar);

            _filteredToolbarActions = allMainActions
                .Where(a => !_excludedActionIds.Contains(a.ActionId))
                .ToList();

            _exportActions = allMainActions
                .Where(a => _exportActionIds.Contains(a.ActionId))
                .ToList();

            await RefreshEnabledStatesAsync();
        }
    }

    private async Task RefreshEnabledStatesAsync()
    {
        var selectedIds = SelectedCellId.HasValue
            ? new List<Guid> { SelectedCellId.Value }
            : new List<Guid>();

        _enabledStates = await Service.GetActionEnabledStatesAsync(
            ToolbarPlacement.MainToolbar, selectedIds);
    }

    private async Task ExecuteActionAsync(ToolbarActionInfo action)
    {
        var selectedIds = SelectedCellId.HasValue
            ? new List<Guid> { SelectedCellId.Value }
            : new List<Guid>();

        try
        {
            await Service.ExecuteActionAsync(action.ActionId, selectedIds);
            await OnActionExecuted.InvokeAsync(action.ActionId);
        }
        catch (Exception ex)
        {
            await OnError.InvokeAsync($"{action.DisplayName} failed: {ex.Message}");
        }
    }

    private async Task OnNew() => await OnNewNotebook.InvokeAsync();
    private void OnOpenClick() => _showOpenInput = !_showOpenInput;

    private async Task OnOpenKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await OnOpenFile();
    }

    private async Task OnOpenFile()
    {
        if (!string.IsNullOrWhiteSpace(_openFilePath))
        {
            await OnOpenNotebook.InvokeAsync(_openFilePath.Trim());
            _showOpenInput = false;
            _openFilePath = "";
        }
    }

    private async Task SwitchLayout(string layoutId)
    {
        await Service.SwitchLayoutAsync(layoutId);
        await RefreshEnabledStatesAsync();
        await OnActionExecuted.InvokeAsync("verso.switchLayout");
    }

    private async Task SwitchTheme(string themeId)
    {
        await Service.SwitchThemeAsync(themeId);
        await RefreshEnabledStatesAsync();
        await OnActionExecuted.InvokeAsync("verso.switchTheme");
    }

    private async Task CycleLayout()
    {
        var layouts = Service.AvailableLayouts;
        if (layouts.Count < 2) return;
        var currentIndex = layouts.ToList().FindIndex(l => string.Equals(l.LayoutId, Service.ActiveLayoutId, StringComparison.OrdinalIgnoreCase));
        var nextIndex = (currentIndex + 1) % layouts.Count;
        await SwitchLayout(layouts[nextIndex].LayoutId);
    }

    private async Task CycleTheme()
    {
        var themes = Service.AvailableThemes;
        if (themes.Count < 2) return;
        var currentIndex = themes.ToList().FindIndex(t => string.Equals(t.ThemeId, Service.ActiveThemeId, StringComparison.OrdinalIgnoreCase));
        var nextIndex = (currentIndex + 1) % themes.Count;
        await SwitchTheme(themes[nextIndex].ThemeId);
    }

    private void ToggleLayoutDropdown()
    {
        _showLayoutDropdown = !_showLayoutDropdown;
        _showThemeDropdown = false;
        _showExportDropdown = false;
    }

    private void ToggleThemeDropdown()
    {
        _showThemeDropdown = !_showThemeDropdown;
        _showLayoutDropdown = false;
        _showExportDropdown = false;
    }

    private void ToggleExportDropdown()
    {
        _showExportDropdown = !_showExportDropdown;
        _showLayoutDropdown = false;
        _showThemeDropdown = false;
    }

    private void OnExportDropdownFocusOut() => _showExportDropdown = false;

    private async Task ExecuteExportAsync(ToolbarActionInfo action)
    {
        _showExportDropdown = false;
        await ExecuteActionAsync(action);
    }

    private async Task SelectLayout(string layoutId)
    {
        _showLayoutDropdown = false;
        await SwitchLayout(layoutId);
    }

    private async Task SelectTheme(string themeId)
    {
        _showThemeDropdown = false;
        await SwitchTheme(themeId);
    }

    private void OnLayoutDropdownFocusOut() => _showLayoutDropdown = false;
    private void OnThemeDropdownFocusOut() => _showThemeDropdown = false;

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null) return;

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); // 50 MB
            using var reader = new System.IO.StreamReader(stream);
            var content = await reader.ReadToEndAsync();
            await OnBrowseNotebook.InvokeAsync((file.Name, content));
            _showOpenInput = false;
            _openFilePath = "";
        }
        catch (Exception ex)
        {
            await OnError.InvokeAsync($"Failed to read file: {ex.Message}");
        }
    }

    private async Task OnSave() => await OnSaveNotebook.InvokeAsync();
    private async Task OnAddCodeCell() => await OnAddCell.InvokeAsync("code");
    private async Task OnAddMarkdownCell() => await OnAddCell.InvokeAsync("markdown");
}
