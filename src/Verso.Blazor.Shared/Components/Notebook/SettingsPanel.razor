<div class="verso-sidebar-panel">
    @if (Service.IsLoaded)
    {
        var allDefinitions = Service.GetSettingDefinitions();
        var enabledExtensionIds = Service.Extensions
            .Where(e => e.Status == ExtensionStatus.Enabled)
            .Select(e => e.ExtensionId)
            .ToHashSet(StringComparer.OrdinalIgnoreCase);
        var visibleDefinitions = allDefinitions
            .Where(d => enabledExtensionIds.Contains(d.ExtensionId))
            .ToList();
        @if (visibleDefinitions.Count == 0)
        {
            <div class="verso-settings-empty">
                <p>No enabled extensions with configurable settings.</p>
            </div>
        }
        else
        {
            @foreach (var group in visibleDefinitions)
            {
                var extId = group.ExtensionId;
                var definitions = group.Definitions;
                var isOpen = _expandedExtensions.Contains(extId);
                var extInfo = Service.Extensions
                    .FirstOrDefault(e => string.Equals(e.ExtensionId, extId, StringComparison.OrdinalIgnoreCase));
                var displayName = extInfo?.Name ?? extId;

                <div class="verso-settings-group">
                    <button class="verso-settings-group-header" @onclick="() => ToggleExtension(extId)">
                        <span class="verso-settings-group-chevron @(isOpen ? "verso-settings-group-chevron--open" : "")">&#9654;</span>
                        <span class="verso-settings-group-label">@displayName</span>
                        <span class="verso-settings-group-count">@definitions.Count</span>
                    </button>
                    @if (isOpen)
                    {
                        var grouped = definitions.OrderBy(d => d.Order).GroupBy(d => d.Category ?? "General");
                        @foreach (var category in grouped)
                        {
                            <div class="verso-settings-category">
                                <div class="verso-settings-category-label">@category.Key</div>
                                @foreach (var def in category)
                                {
                                    var d = def;
                                    var currentValue = Service.GetSettingValue(extId, d.Name) ?? d.DefaultValue;
                                    <div class="verso-settings-item">
                                        <label class="verso-settings-label">@d.DisplayName</label>
                                        <div class="verso-settings-description">@d.Description</div>
                                        <div class="verso-settings-control">
                                            @switch (d.SettingType)
                                            {
                                                case SettingType.Boolean:
                                                    <input type="checkbox"
                                                           checked="@(currentValue is true)"
                                                           @onchange="e => HandleChange(extId, d.Name, e.Value)" />
                                                    break;

                                                case SettingType.Integer:
                                                    <input type="number"
                                                           value="@currentValue"
                                                           step="1"
                                                           min="@(d.Constraints?.MinValue)"
                                                           max="@(d.Constraints?.MaxValue)"
                                                           @onchange="e => HandleIntChange(extId, d.Name, e.Value)" />
                                                    break;

                                                case SettingType.Double:
                                                    <input type="number"
                                                           value="@currentValue"
                                                           step="0.1"
                                                           min="@(d.Constraints?.MinValue)"
                                                           max="@(d.Constraints?.MaxValue)"
                                                           @onchange="e => HandleDoubleChange(extId, d.Name, e.Value)" />
                                                    break;

                                                case SettingType.StringChoice:
                                                    <select value="@currentValue"
                                                            @onchange="e => HandleChange(extId, d.Name, e.Value)">
                                                        @if (d.Constraints?.Choices is { } choices)
                                                        {
                                                            @foreach (var choice in choices)
                                                            {
                                                                <option value="@choice" selected="@(string.Equals(choice, currentValue?.ToString(), StringComparison.Ordinal))">@choice</option>
                                                            }
                                                        }
                                                    </select>
                                                    break;

                                                default:
                                                    <input type="text"
                                                           value="@currentValue"
                                                           maxlength="@(d.Constraints?.MaxLength)"
                                                           @onchange="e => HandleChange(extId, d.Name, e.Value)" />
                                                    break;
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            }
        }
    }
    else
    {
        <div class="verso-settings-empty">
            <p>No notebook is open.</p>
        </div>
    }
</div>

@code {
    [Parameter] public INotebookService Service { get; set; } = default!;

    private readonly HashSet<string> _expandedExtensions = new();

    private void ToggleExtension(string extensionId)
    {
        if (!_expandedExtensions.Remove(extensionId))
            _expandedExtensions.Add(extensionId);
    }

    private async Task HandleChange(string extensionId, string settingName, object? value)
    {
        await Service.UpdateSettingAsync(extensionId, settingName, value);
    }

    private async Task HandleIntChange(string extensionId, string settingName, object? value)
    {
        if (int.TryParse(value?.ToString(), out var intVal))
            await Service.UpdateSettingAsync(extensionId, settingName, intVal);
    }

    private async Task HandleDoubleChange(string extensionId, string settingName, object? value)
    {
        if (double.TryParse(value?.ToString(), out var dblVal))
            await Service.UpdateSettingAsync(extensionId, settingName, dblVal);
    }
}
