<div class="verso-sidebar-panel">
    <div class="verso-variable-toolbar">
        <button class="verso-cell-btn" title="Refresh" @onclick="Refresh">&#8635;</button>
    </div>

    @if (_entries.Count == 0)
    {
        <div class="verso-variable-empty">No variables defined.</div>
    }
    else
    {
        <table class="verso-variable-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entry in _entries)
                {
                    var v = entry;
                    <tr class="verso-variable-row @(_inspecting == v.Name ? "verso-variable-row--selected" : "")"
                        @onclick="() => InspectAsync(v.Name)">
                        <td>@v.Name</td>
                        <td>@v.TypeName</td>
                        <td class="verso-variable-preview">@v.ValuePreview</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (_inspectContent is not null)
    {
        <div class="verso-variable-inspect-panel">
            <div class="verso-variable-inspect-header">
                <span>@_inspecting</span>
                <button class="verso-cell-btn" @onclick="CloseInspect">&#10005;</button>
            </div>
            <div class="verso-variable-inspect-body">
                @if (_inspectMimeType == "text/html")
                {
                    @((MarkupString)_inspectContent)
                }
                else
                {
                    <pre>@_inspectContent</pre>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public INotebookService Service { get; set; } = default!;

    private List<VariableEntryDto> _entries = new();
    private string? _inspecting;
    private string? _inspectContent;
    private string _inspectMimeType = "text/plain";

    protected override void OnParametersSet()
    {
        Refresh();
    }

    private void Refresh()
    {
        _entries = Service.GetVariables().ToList();
    }

    private async Task InspectAsync(string name)
    {
        _inspecting = name;

        var result = await Service.InspectVariableAsync(name);
        if (result is null)
        {
            _inspectContent = "null";
            _inspectMimeType = "text/plain";
            return;
        }

        _inspectMimeType = result.MimeType;
        _inspectContent = result.Content;
    }

    private void CloseInspect()
    {
        _inspecting = null;
        _inspectContent = null;
    }
}
